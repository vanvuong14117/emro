var LocalStorageHandler=function(param){if(!param||"undefined"===param){var err={};err.code=3E7;err.message="[LocalStorageHandler Initializing Failed] the parameter value cannot be null.";err.detail=null;throw err;}var __storage=null;var __encrypt=null;try{__storage=new LocalStorage(param.err_code);__encrypt=new EncryptStorage(param.err_code)}catch(e){throw e;}var __json_init_cacerts=NPKICACertObject;var __json_certs=null;var __json_ca_certs=null;var __arr_list_user_certs=null;var __enc_algo=param.enc_algo;var __hash_algo=param.hash_algo;var __pki=param.pki;var __err_code=param.err_code;var __domain=param.domain;if(!__domain)__domain=document.domain;if(!__json_init_cacerts){var err={};err.code=__err_code.ERROR_CA_CERTS_FORM_IS_NOT_DOWNLOADED;err.message="[LocalStorageHandler Initializing Failed] ca certificates are not downloaded.";err.detail=null;throw err;}var console=window.console||{log:function(){}};return{InstallCACerts:function(pw){if(!pw){var err={};err.code=__err_code.ERROR_PARAMETER_VALUE_IS_NULL;err.message="[LocalStorageHandler InstallCACerts Failed] the parameter value cannot be null.";err.detail=null;throw err;}var strJson=null;try{strJson=JSON.stringify(__json_init_cacerts)}catch(e$0){var err={};err.code=__err_code.ERROR_JSON_OBJECT_TO_STRING;err.message="[LocalStorageHandler InstallCACerts Failed] json object to string is failed.";err.detail=e$0;throw err;}var secSt=null;try{secSt=__encrypt.MakeKey(pw,__enc_algo,__hash_algo)}catch(e$1){throw e$1;}var encItem=null;try{encItem=__encrypt.EncryptItem(__enc_algo,secSt.key,secSt.iv,strJson)}catch(e$2){throw e$2;}var strB64Id=null;try{strB64Id=crosscert.util.encode64(secSt.id)}catch(e$3){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler InstallCACerts Failed][TOOLKIT ERROR][1] during encoding base64.";err.detail="error code : "+e$3.code+"\nerror message : "+e$3.message;throw err;}var strB64EncItem=null;try{strB64EncItem=crosscert.util.encode64(encItem)}catch(e$4){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler InstallCACerts Failed][TOOLKIT ERROR][2] during encoding base64.";err.detail="error code : "+e$4.code+"\nerror message : "+e$4.message;throw err;}try{if("NPKI"===__pki)__storage.SetItem("N"+strB64Id,strB64EncItem);else if("GPKI"===__pki)__storage.SetItem("G"+strB64Id,strB64EncItem);else if("PPKI"===__pki)__storage.SetItem("P"+strB64Id,strB64EncItem);else;}catch(e$5){throw e$5;}return},LoadAllCerts:function(pw){if(!pw){var err={};err.code=__err_code.ERROR_PARAMETER_VALUE_IS_NULL;err.message="[LocalStorageHandler LoadAllCerts Failed] the parameter value cannot be null.";err.detail=null;throw err;}var secSt=null;try{secSt=__encrypt.MakeKey(pw,__enc_algo,__hash_algo)}catch(e$6){throw e$6;}var strB64Id=null;try{strB64Id=crosscert.util.encode64(secSt.id)}catch(e$7){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler LoadAllCerts Failed][TOOLKIT ERROR] during encoding base64.";err.detail="error code : "+e$7.code+"\nerror message : "+e$7.message;throw err;}var strB64EncItem=null;try{if("NPKI"===__pki)strB64EncItem=__storage.GetItem("N"+strB64Id);else if("GPKI"===__pki)strB64EncItem=__storage.GetItem("G"+strB64Id);else if("PPKI"===__pki)strB64EncItem=__storage.GetItem("P"+strB64Id);else;if(!strB64EncItem){var err={};err.code=__err_code.ERROR_FIRST_USING_OR_PASSWORD_IS_WRONG;err.message="[LocalStorageHandler LoadAllCerts Failed] first using or the storage password is wrong.";err.detail=null;throw err;}}catch(e$8){throw e$8;}var encItem=null;try{encItem=crosscert.util.decode64(strB64EncItem)}catch(e$9){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler LoadAllCerts Failed][TOOLKIT ERROR] during decoding base64.";err.detail="error code : "+e$9.code+"\nerror message : "+e$9.message;throw err;}var item=null;try{item=__encrypt.DecryptItem(__enc_algo,secSt.key,secSt.iv,encItem)}catch(e$10){throw e$10;}var objJson=null;try{objJson=JSON.parse(item)}catch(e$11){var err={};err.code=__err_code.ERROR_JSON_STRING_TO_OBJECT;err.message="[LocalStorageHandler LoadAllCerts Failed] json string to object is failed.";err.detail=e$11;throw err;}__json_certs=objJson;for(var key in __json_init_cacerts)if(__json_certs[key])if(__json_certs[key].ca&&__json_certs[key].ca.length>1)for(var caKey in __json_init_cacerts[key].ca){if(typeof __json_certs[key].ca.caKey=="undefined")__json_certs[key].ca.caKey=__json_init_cacerts[key].ca.caKey}else __json_certs[key].ca=__json_init_cacerts[key].ca;else __json_certs[key]=__json_init_cacerts[key];try{this.GetCACerts();this.GetUserCerts(pw)}catch(e$12){throw e$12;}pw=secSt=secSt.key=secSt.iv=secSt.id=null;return},GetCACerts:function(){if(!__json_ca_certs)if("NPKI"===__pki){var strJson="";var jsonObj=null;for(var ca in __json_certs){try{jsonObj=function(){return eval("__json_certs."+ca+".ca")}()}catch(e$13){var err={};err.code=__err_code.ERROR_UNSUPPORTING_CA;err.message="[LocalStorageHandler GetCACerts Failed] unsupporting ca.";err.detail=e$13;throw err;}for(var key in jsonObj){if(!jsonObj[key]||"undefined"===typeof jsonObj[key]){var err={};err.code=__err_code.ERROR_CA_CERT_IS_NULL;err.message="[LocalStorageHandler GetCACerts Failed] ca certificate is null.";err.detail=null;throw err;}strJson+='"'+key+'":"'+jsonObj[key]+'",'}}strJson=strJson.substring(0,strJson.length-1);strJson="{"+strJson+"}";try{__json_ca_certs=JSON.parse(strJson)}catch(e$14){var err={};err.code=__err_code.ERROR_JSON_STRING_TO_OBJECT;err.message="[LocalStorageHandler GetCACerts Failed] json string to object is failed.";err.detail=e$14;throw err;}}else if("GPKI"===__pki);else;return __json_ca_certs},GetUserCerts:function(pw){if(!pw){var err={};err.code=__err_code.ERROR_PARAMETER_VALUE_IS_NULL;err.message="[LocalStorageHandler GetUserCerts Failed] the parameter value cannot be null.";err.detail=null;throw err;}__arr_list_user_certs=new Array;var jsonObj=null;var listIdx=1;var secSt=null;try{secSt=__encrypt.MakeKey(pw,__enc_algo,__hash_algo)}catch(e$15){throw e$15;}var strB64Key=null;try{strB64Key=crosscert.util.encode64(secSt.key)}catch(e$16){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetUserCerts Failed][TOOLKIT ERROR][1] during encoding base64.";err.detail="error code : "+e$16.code+"\nerror message : "+e$16.message;throw err;}var secSt2=null;try{secSt2=__encrypt.MakeKey(strB64Key+__domain,__enc_algo,__hash_algo)}catch(e$17){throw e$17;}var p12key=null;try{p12key=crosscert.util.encode64(secSt2.key)}catch(e$18){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetUserCerts Failed][TOOLKIT ERROR][2] during encoding base64.";err.detail="error code : "+e$18.code+"\nerror message : "+e$18.message;throw err;}if("NPKI"===__pki)for(var ca in __json_certs){try{jsonObj=function(){return eval("__json_certs."+ca+".user")}()}catch(e$19){var err={};err.code=__err_code.ERROR_UNSUPPORTING_CA;err.message="[LocalStorageHandler GetUserCerts Failed] unsupporting ca.";err.detail=e$19;throw err;}if("undefined"===typeof jsonObj)continue;for(var b64dn in jsonObj){var b64p12,p12der,p12,certNKey;b64p12=p12der=p12=certNKey=null;if(!jsonObj[b64dn]||"undefined"===typeof jsonObj[b64dn]){var err={};err.code=__err_code.ERROR_USER_CERT_IS_NULL;err.message="[LocalStorageHandler GetUserCerts Failed] user certificate is null.";err.detail=null;throw err;}b64p12=jsonObj[b64dn];try{p12der=crosscert.asn1.fromDer(crosscert.util.decode64(b64p12));p12=crosscert.pkcs12.getCertNKeyFromPKCS12WithEncPKCS8(p12der,p12key);certNKey=p12.getCertAndKeyFromPKCS12(p12key)}catch(e$20){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetUserCerts Failed][TOOLKIT ERROR] during parsing pkcs12.";err.detail="error code : "+e$20.code+"\nerror message : "+e$20.message;throw err;}var struct=new Object;struct["ca"]=ca;var bindn=null;try{bindn=crosscert.util.decode64(b64dn)}catch(e$21){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetUserCerts Failed][TOOLKIT ERROR] during decoding base64.";err.detail="error code : "+e$21.code+"\nerror message : "+e$21.message;throw err;}var dn=null;try{dn=crosscert.util.decodeUtf8(bindn)}catch(e$22){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetUserCerts Failed][TOOLKIT ERROR] during decoding utf8.";err.detail="error code : "+e$22.code+"\nerror message : "+e$22.message;throw err;}struct["dn"]=dn;var signcert=null;try{if(!certNKey.sign.cert&&certNKey.km.cert)signcert=crosscert.pki.certificateToBase64(certNKey.km.cert);else signcert=crosscert.pki.certificateToBase64(certNKey.sign.cert)}catch(e$23){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetUserCerts Failed][TOOLKIT ERROR] during sign certificate to base64.";err.detail="error code : "+e$23.code+"\nerror message : "+e$23.message;throw err;}struct["signcert"]=signcert;var signpri=null;try{if(!certNKey.sign.prikey&&certNKey.km.cert)signpri=crosscert.pkcs8.encryptedPrivateKeyToBase64(certNKey.km.prikey);else signpri=crosscert.pkcs8.encryptedPrivateKeyToBase64(certNKey.sign.prikey)}catch(e$24){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetUserCerts Failed][TOOLKIT ERROR] during sign private key to base64.";err.detail="error code : "+e$24.code+"\nerror message : "+e$24.message;throw err;}struct["signpri"]=signpri;if("undefined"!=typeof certNKey.km){var kmcert=null;try{kmcert=crosscert.pki.certificateToBase64(certNKey.km.cert)}catch(e$25){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetUserCerts Failed][TOOLKIT ERROR] during km certificate to base64.";err.detail="error code : "+e$25.code+"\nerror message : "+e$25.message;throw err;}struct["kmcert"]=kmcert;var kmpri=null;try{kmpri=crosscert.pkcs8.encryptedPrivateKeyToBase64(certNKey.km.prikey)}catch(e$26){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetUserCerts Failed][TOOLKIT ERROR] during km private key to base64.";err.detail="error code : "+e$26.code+"\nerror message : "+e$26.message;throw err;}struct["kmpri"]=kmpri}__arr_list_user_certs[listIdx++]=struct}}else if("GPKI"===__pki);else;pw=secSt=secSt.key=secSt.iv=secSt.id=secSt2=secSt2.key=secSt2.iv=secSt2.id=null;return __arr_list_user_certs},SetUserCertOnMemory:function(json_user_cert){if(!json_user_cert){var err={};err.code=__err_code.ERROR_PARAMETER_VALUE_IS_NULL;err.message="[LocalStorageHandler SetUserCertOnMemory Failed] the parameter value cannot be null.";err.detail=null;throw err;}__arr_list_user_certs=new Array;var struct=new Object;var listIdx=1;for(var objKey in json_user_cert)switch(objKey){case "signcert":struct["signcert"]=json_user_cert.signcert;break;case "signpri":struct["signpri"]=json_user_cert.signpri;break;case "kmcert":struct["kmcert"]=json_user_cert.kmcert;break;case "kmpri":struct["kmpri"]=json_user_cert.kmpri;break;default:break}__arr_list_user_certs[listIdx]=struct;return{"index":listIdx,"aluc":__arr_list_user_certs}},SaveUserCert:function(ca,json_user_new_cert,pw,dupl_check_flag){if(!ca||!json_user_new_cert||!pw||"boolean"!==typeof dupl_check_flag){var err={};err.code=__err_code.ERROR_PARAMETER_VALUE_IS_NULL;err.message="[LocalStorageHandler SaveUserCert Failed] the parameter value cannot be null.";err.detail=null;throw err;}ca=ca.toLowerCase();var signCert,signPri,kmCert,kmPri,p12,strB64P12;signCert=signPri=kmCert=kmPri=p12=strB64P12=null;var secSt,secSt2,strB64Key,p12key;secSt=secSt2=strB64Key=p12key=null;try{secSt=__encrypt.MakeKey(pw,__enc_algo,__hash_algo)}catch(e$27){throw e$27;}try{strB64Key=crosscert.util.encode64(secSt.key)}catch(e$28){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR][1] during encoding base64.";err.detail="error code : "+e$28.code+"\nerror message : "+e$28.message;throw err;}try{secSt2=__encrypt.MakeKey(strB64Key+__domain,__enc_algo,__hash_algo)}catch(e$29){throw e$29;}try{p12key=crosscert.util.encode64(secSt2.key)}catch(e$30){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR][2] during encoding base64.";err.detail="error code : "+e$30.code+"\nerror message : "+e$30.message;throw err;}for(var objKey in json_user_new_cert)switch(objKey){case "signcert":try{signCert=crosscert.pki.certificateFromBase64(json_user_new_cert.signcert)}catch(e$31){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during converting sign certificate from base64.";err.detail="error code : "+e$31.code+"\nerror message : "+e$31.message;throw err;}break;case "signpri":try{signPri=crosscert.pkcs8.encryptedPrivateKeyFromBase64(json_user_new_cert.signpri)}catch(e$32){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during converting sign private key from base64.";err.detail="error code : "+e$32.code+"\nerror message : "+e$32.message;throw err;}break;case "kmcert":try{kmCert=crosscert.pki.certificateFromBase64(json_user_new_cert.kmcert)}catch(e$33){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during converting km certificate from base64.";err.detail="error code : "+e$33.code+"\nerror message : "+e$33.message;throw err;}break;case "kmpri":try{kmPri=crosscert.pkcs8.encryptedPrivateKeyFromBase64(json_user_new_cert.kmpri)}catch(e$34){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during converting km private key from base64.";err.detail="error code : "+e$34.code+"\nerror message : "+e$34.message;throw err;}break;default:break}try{p12=crosscert.pkcs12.makePKCS12FromCertNEncPKCS8(signCert,signPri,kmCert,kmPri,p12key,{useMac:true,generateLocalKeyId:true})}catch(e$35){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during encrypting pkcs8 and making pkcs12.";err.detail="error code : "+e$35.code+"\nerror message : "+e$35.message;throw err;}try{strB64P12=crosscert.util.encode64(crosscert.asn1.toDer(p12).getBytes())}catch(e$36){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR][3] during encoding base64.";err.detail="error code : "+e$36.code+"\nerror message : "+e$36.message;throw err;}try{crosscert.x509Certificate.parser(json_user_new_cert.signcert,"Base64")}catch(e$37){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during parsing new x.509 certificate.";err.detail="error code : "+e$37.code+"\nerror message : "+e$37.message;throw err;}var userDN=null;try{userDN=crosscert.x509Certificate.getSubjectName()}catch(e$38){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during getting subject name.";err.detail="error code : "+e$38.code+"\nerror message : "+e$38.message;throw err;}var binDN=null;try{binDN=crosscert.util.encodeUtf8(userDN)}catch(e$39){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during encoding utf8.";err.detail="error code : "+e$39.code+"\nerror message : "+e$39.message;throw err;}var strB64DN=null;try{strB64DN=crosscert.util.encode64(binDN)}catch(e$40){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR][3] during encoding base64.";err.detail="error code : "+e$40.code+"\nerror message : "+e$40.message;throw err;}var user=null;if(typeof __json_certs[ca]=="undefined"){__json_certs[ca]={};__json_certs[ca].user=[]}try{user=function(){return eval("__json_certs."+ca+".user")}()}catch(e$41){var err={};err.code=__err_code.ERROR_UNSUPPORTING_CA;err.message="[LocalStorageHandler SaveUserCert Failed] unsupporting ca.";err.detail=e$41;throw err;}if(dupl_check_flag&&user[strB64DN]){var date=null;var newCertStartedDate=null;var newCertStartedMillisec=0;var newCertExpiredDate=null;var newCertExpiredMillisec=0;try{date=crosscert.x509Certificate.getNotBefore();newCertStartedDate=new Date(date);newCertStartedMillisec=newCertStartedDate.getTime();date=crosscert.x509Certificate.getNotAfter();newCertExpiredDate=new Date(date);newCertExpiredMillisec=newCertExpiredDate.getTime()}catch(e$42){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during getting started and expired date of new certificate.";err.detail="error code : "+e$42.code+"\nerror message : "+e$42.message;throw err;}var existb64signcert=null;try{var existp12bin=crosscert.util.decode64(user[strB64DN]);var existp12der=crosscert.asn1.fromDer(existp12bin);var existp12=crosscert.pkcs12.getCertNKeyFromPKCS12WithEncPKCS8(existp12der,p12key);var existcertnkey=existp12.getCertAndKeyFromPKCS12(p12key);if(!existcertnkey.sign.cert&&existcertnkey.km.cert)existb64signcert=crosscert.pki.certificateToBase64(existcertnkey.km.cert);else existb64signcert=crosscert.pki.certificateToBase64(existcertnkey.sign.cert)}catch(e$43){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during getting sign certificate from pkcs12.";err.detail="error code : "+e$43.code+"\nerror message : "+e$43.message;throw err;}try{crosscert.x509Certificate.parser(existb64signcert,"Base64")}catch(e$44){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during parsing original x.509 certificate.";err.detail="error code : "+e$44.code+"\nerror message : "+e$44.message;throw err;}var existCertStartedDate=null;var existCertStartedMillisec=0;var existCertExpiredDate=null;var existCertExpiredMillisec=0;try{date=crosscert.x509Certificate.getNotBefore();existCertStartedDate=new Date(date);existCertStartedMillisec=existCertStartedDate.getTime();date=crosscert.x509Certificate.getNotAfter();existCertExpiredDate=new Date(date);existCertExpiredMillisec=existCertExpiredDate.getTime()}catch(e$45){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during getting started and expired date of original certificate.";err.detail="error code : "+e$45.code+"\nerror message : "+e$45.message;throw err;}var timegap=existCertExpiredMillisec-newCertExpiredMillisec;if(0===timegap){if(0<existCertStartedMillisec-newCertStartedMillisec){var err={};err.code=__err_code.ERROR_ORIGINAL_CERT_IS_LATEST;err.message="[LocalStorageHandler SaveUserCert Failed] original certificate is latest.";err.detail=null;throw err;}}else if(0>timegap);else{var err={};err.code=__err_code.ERROR_ORIGINAL_CERT_IS_LATEST;err.message="[LocalStorageHandler SaveUserCert Failed] original certificate is latest.";err.detail=null;throw err;}}user[strB64DN]=strB64P12;var encItem=null;try{encItem=__encrypt.EncryptItem(__enc_algo,secSt.key,secSt.iv,JSON.stringify(__json_certs))}catch(e$46){throw e$46;}var strB64Id=null;try{strB64Id=crosscert.util.encode64(secSt.id)}catch(e$47){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR][4] during encoding base64.";err.detail="error code : "+e$47.code+"\nerror message : "+e$47.message;throw err;}var strB64EncItem=null;try{strB64EncItem=crosscert.util.encode64(encItem)}catch(e$48){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR][5] during encoding base64.";err.detail="error code : "+e$48.code+"\nerror message : "+e$48.message;throw err;}pw=secSt=secSt.key=secSt.iv=secSt.id=secSt2=secSt2.key=secSt2.iv=secSt2.id=null;var pre=null;if("NPKI"===__pki)pre="N";else if("GPKI"===__pki)pre="G";else if("PPKI"===__pki)pre="P";else;try{__storage.SetItem(pre+strB64Id,strB64EncItem)}catch(e$49){signCert=signPri=kmCert=kmPri=p12=strB64P12=strB64EncItem=json_user_new_cert=strB64DN=strB64Id=strB64Key=p12key=null;throw e$49;}try{this.SetUserCertOnMemory(json_user_new_cert)}catch(e$50){signCert=signPri=kmCert=kmPri=p12=strB64P12=strB64EncItem=json_user_new_cert=strB64DN=strB64Id=strB64Key=p12key=null;throw e$50;}signCert=signPri=kmCert=kmPri=p12=strB64P12=strB64EncItem=json_user_new_cert=strB64DN=strB64Id=strB64Key=p12key=null;return},DeleteUserCertByIndex:function(index,pw){if(!index||!pw){var err={};err.code=__err_code.ERROR_PARAMETER_VALUE_IS_NULL;err.message="[LocalStorageHandler DeleteUserCertByIndex Failed] the parameter value cannot be null.";err.detail=null;throw err;}if("number"!=typeof index||1>index){var err={};err.code=__err_code.ERROR_PARAMETER_TYPE_OF_VALUE_OR_DATA_IS_WRONG;err.message="[LocalStorageHandler DeleteUserCertByIndex Failed] the parameter type of value or data is wrong.";err.detail=null;throw err;}if(!__arr_list_user_certs||0>=__arr_list_user_certs.length){var err={};err.code=__err_code.ERROR_NO_USER_CERT_ON_STORAGE_MEMORY;err.message="[LocalStorageHandler DeleteUserCertByIndex Failed] user certificate is not loaded or not exist.";err.detail=null;throw err;}var struct=__arr_list_user_certs[index];if(!struct||"undefined"===typeof struct){var err={};err.code=__err_code.ERROR_NO_USER_CERT_RESPONDED_BY_INDEX;err.message="[LocalStorageHandler DeleteUserCertByIndex Failed] no user certificate responded by the index.";err.detail=null;throw err;}var ca=struct["ca"];var dn=struct["dn"];try{this.DeleteUserCertByDN(ca,dn,pw)}catch(e$51){throw e$51;}return},DeleteUserCertByDN:function(ca,dn,pw){if(!ca||!dn||!pw){var err={};err.code=__err_code.ERROR_PARAMETER_VALUE_IS_NULL;err.message="[LocalStorageHandler DeleteUserCertByDN Failed] the parameter value cannot be null.";err.detail=null;throw err;}ca=ca.toLowerCase();var binDN=null;try{binDN=crosscert.util.encodeUtf8(dn)}catch(e$52){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SaveUserCert Failed][TOOLKIT ERROR] during encoding utf8.";err.detail="error code : "+e$52.code+"\nerror message : "+e$52.message;throw err;}var strB64DN=null;try{strB64DN=crosscert.util.encode64(binDN)}catch(e$53){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler DeleteUserCertByDN Failed][TOOLKIT ERROR][1] during encoding base64.";err.detail="error code : "+e$53.code+"\nerror message : "+e$53.message;throw err;}var user=null;try{user=function(){return eval("__json_certs."+ca+".user")}()}catch(e$54){var err={};err.code=__err_code.ERROR_UNSUPPORTING_CA;err.message="[LocalStorageHandler DeleteUserCertByDN Failed] unsupporting ca.";err.detail=e$54;throw err;}if(user[strB64DN]){try{delete user[strB64DN]}catch(e$55){var err={};err.code=__err_code.ERROR_DELETING_USER_CERT_TO_STORAGE_MEMORY;err.message="[LocalStorageHandler DeleteUserCertByDN Failed] deleting user certificate to storage memory.";err.detail=e$55;throw err;}var secSt,encItem,strB64Id,strB64EncItem;secSt=encItem=strB64Id=strB64EncItem=null;try{secSt=__encrypt.MakeKey(pw,__enc_algo,__hash_algo)}catch(e$56){throw e$56;}try{encItem=__encrypt.EncryptItem(__enc_algo,secSt.key,secSt.iv,JSON.stringify(__json_certs))}catch(e$57){throw e$57;}try{strB64Id=crosscert.util.encode64(secSt.id)}catch(e$58){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler DeleteUserCertByDN Failed][TOOLKIT ERROR][2] during encoding base64.";err.detail="error code : "+e$58.code+"\nerror message : "+e$58.message;throw err;}try{strB64EncItem=crosscert.util.encode64(encItem)}catch(e$59){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler DeleteUserCertByDN Failed][TOOLKIT ERROR][3] during encoding base64.";err.detail="error code : "+e$59.code+"\nerror message : "+e$59.message;throw err;}var pre=null;if("NPKI"===__pki)pre="N";else if("GPKI"===__pki)pre="G";else if("PPKI"===__pki)pre="P";else;try{__storage.SetItem(pre+strB64Id,strB64EncItem)}catch(e$60){throw e$60;}}else{var err={};err.code=__err_code.ERROR_NO_USER_CERT_RESPONDED_BY_DN;err.message="[LocalStorageHandler DeleteUserCertByDN Failed] no user certificate responded by the dn.";err.detail=null;throw err;}return},SetP12OnMemory:function(b64_p12,pw){if(!b64_p12||!pw){var err={};err.code=__err_code.ERROR_PARAMETER_VALUE_IS_NULL;err.message="[LocalStorageHandler SetP12OnMemory Failed] the parameter value cannot be null.";err.detail=null;throw err;}var console=window.console||{log:function(){}};var bin=null;try{bin=crosscert.util.decode64(b64_p12)}catch(e$61){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SetP12OnMemory Failed][TOOLKIT ERROR] during decoding base64.";err.detail="error code : "+e$61.code+"\nerror message : "+e$61.message;throw err;}var der=null;try{der=crosscert.asn1.fromDer(bin)}catch(e$62){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SetP12OnMemory Failed][TOOLKIT ERROR] during loading binary on memory.";err.detail="error code : "+e$62.code+"\nerror message : "+e$62.message;throw err;}var p12=null;try{p12=crosscert.pkcs12.getCertNKeyFromPKCS12(der,pw)}catch(e$63){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SetP12OnMemory Failed][TOOLKIT ERROR] during loading asn.1 on memory.";err.detail="error code : "+e$63.code+"\nerror message : "+e$63.message;throw err;}var certNKey=null;try{certNKey=p12.getCertAndKeyFromPKCS12(pw)}catch(e$64){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SetP12OnMemory Failed][TOOLKIT ERROR] during decoding pkcs#12.";err.detail="error code : "+e$64.code+"\nerror message : "+e$64.message;throw err;}var jsonCert={};try{if(!certNKey.sign.cert&&certNKey.km.cert){jsonCert["signcert"]=crosscert.pki.certificateToBase64(certNKey.km.cert);jsonCert["signpri"]=crosscert.pkcs8.encryptedPrivateKeyToBase64(certNKey.km.prikey)}else{jsonCert["signcert"]=crosscert.pki.certificateToBase64(certNKey.sign.cert);jsonCert["signpri"]=crosscert.pkcs8.encryptedPrivateKeyToBase64(certNKey.sign.prikey)}if("undefined"!==typeof certNKey.km){jsonCert["kmcert"]=crosscert.pki.certificateToBase64(certNKey.km.cert);jsonCert["kmpri"]=crosscert.pkcs8.encryptedPrivateKeyToBase64(certNKey.km.prikey)}}catch(e$65){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SetP12OnMemory Failed][TOOLKIT ERROR] during getting certificate n private key to base64.";err.detail="error code : "+e$65.code+"\nerror message : "+e$65.message;throw err;}var jsonRv={};try{jsonRv=this.SetUserCertOnMemory(jsonCert)}catch(e$66){throw e$66;}return jsonRv},SetP12HexOnMemory:function(hex_p12,hex_pw){if(!hex_p12||!hex_pw){var err={};err.code=__err_code.ERROR_PARAMETER_VALUE_IS_NULL;err.message="[LocalStorageHandler SetP12HexOnMemory Failed] the parameter value cannot be null.";err.detail=null;throw err;}var console=window.console||{log:function(){}};var bin=null;try{bin=crosscert.util.hexToBytes(hex_p12)}catch(e$67){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SetP12HexOnMemory Failed][TOOLKIT ERROR] during decoding hex string.";err.detail="error code : "+e$67.code+"\nerror message : "+e$67.message;throw err;}var der=null;try{der=crosscert.asn1.fromDer(bin)}catch(e$68){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SetP12HexOnMemory Failed][TOOLKIT ERROR] during loading binary on memory.";err.detail="error code : "+e$68.code+"\nerror message : "+e$68.message;throw err;}var p12=null;try{p12=crosscert.pkcs12.getCertNKeyFromPKCS12WithEncPKCS8(der,hex_pw)}catch(e$69){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SetP12HexOnMemory Failed][TOOLKIT ERROR] during loading asn.1 on memory.";err.detail="error code : "+e$69.code+"\nerror message : "+e$69.message;throw err;}var certNKey=null;try{certNKey=p12.getCertAndKeyFromPKCS12(hex_pw)}catch(e$70){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SetP12HexOnMemory Failed][TOOLKIT ERROR] during decoding pkcs#12.";err.detail="error code : "+e$70.code+"\nerror message : "+e$70.message;throw err;}var jsonCert={};try{if(!certNKey.sign.cert&&certNKey.km.cert){jsonCert["signcert"]=crosscert.pki.certificateToBase64(certNKey.km.cert);jsonCert["signpri"]=crosscert.pkcs8.encryptedPrivateKeyToBase64(certNKey.km.prikey)}else{jsonCert["signcert"]=crosscert.pki.certificateToBase64(certNKey.sign.cert);jsonCert["signpri"]=crosscert.pkcs8.encryptedPrivateKeyToBase64(certNKey.sign.prikey)}if("undefined"!==typeof certNKey.km){jsonCert["kmcert"]=crosscert.pki.certificateToBase64(certNKey.km.cert);jsonCert["kmpri"]=crosscert.pkcs8.encryptedPrivateKeyToBase64(certNKey.km.prikey)}}catch(e$71){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler SetP12HexOnMemory Failed][TOOLKIT ERROR] during getting certificate n private key to base64.";err.detail="error code : "+e$71.code+"\nerror message : "+e$71.message;throw err;}var jsonRv={};try{jsonRv=this.SetUserCertOnMemory(jsonCert)}catch(e$72){throw e$72;}return jsonRv},GetP12ForBuToPc:function(index,pw,retType){if(!index||!pw){var err={};err.code=__err_code.ERROR_PARAMETER_VALUE_IS_NULL;err.message="[LocalStorageHandler GetP12ForBuToPc Failed] the parameter value cannot be null.";err.detail=null;throw err;}if("number"!=typeof index||"string"!=typeof pw||1>index||1>pw.length){var err={};err.code=__err_code.ERROR_PARAMETER_TYPE_OF_VALUE_OR_DATA_IS_WRONG;err.message="[LocalStorageHandler GetP12ForBuToPc Failed] the parameter type of value or data is wrong.";err.detail=null;throw err;}if(!__arr_list_user_certs||0>=__arr_list_user_certs.length){var err={};err.code=__err_code.ERROR_NO_USER_CERT_ON_STORAGE_MEMORY;err.message="[LocalStorageHandler GetP12ForBuToPc Failed] user certificate is not loaded or not exist.";err.detail=null;throw err;}var b64SignCert,b64SignPri,b64KmCert,b64kmPri;b64SignCert=b64SignPri=b64KmCert=b64KmPri=null;var p12,p12bin;p12=p12bin=null;var struct=__arr_list_user_certs[index];if(!struct||"undefined"===typeof struct){var err={};err.code=__err_code.ERROR_NO_USER_CERT_RESPONDED_BY_INDEX;err.message="[LocalStorageHandler GetP12ForBuToPc Failed] no user certificate responded by the index.";err.detail=null;throw err;}var b64SignCert=struct["signcert"];var b64SignPri=struct["signpri"];if("undefined"!=typeof struct["kmcert"])if(b64SignCert!=struct["kmcert"]&&b64SignPri!=struct["kmpri"]){b64KmCert=struct["kmcert"];b64KmPri=struct["kmpri"]}var dn=null;try{crosscert.x509Certificate.parser(b64SignCert,"Base64");dn=crosscert.x509Certificate.getSubjectName()}catch(e$73){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToPc Failed][TOOLKIT ERROR] during parsing certificate and getting subject name.";err.detail="error code : "+e$73.code+"\nerror message : "+e$73.message;throw err;}var signCert=null;try{signCert=crosscert.pki.certificateFromBase64(b64SignCert)}catch(e$74){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToPc Failed][TOOLKIT ERROR] during decoding sign certificate base64 to binary.";err.detail="error code : "+e$74.code+"\nerror message : "+e$74.message;throw err;}var signPri=null;try{signPri=crosscert.pkcs8.encryptedPrivateKeyFromBase64(b64SignPri)}catch(e$75){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToPc Failed][TOOLKIT ERROR] during decoding sign private key base64 to binary.";err.detail="error code : "+e$75.code+"\nerror message : "+e$75.message;throw err;}var kmCert=null;var kmPri=null;if(b64KmCert){try{kmCert=crosscert.pki.certificateFromBase64(b64KmCert)}catch(e$76){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToPc Failed][TOOLKIT ERROR] during decoding km certificate base64 to binary.";err.detail="error code : "+e$76.code+"\nerror message : "+e$76.message;throw err;}try{kmPri=crosscert.pkcs8.encryptedPrivateKeyFromBase64(b64KmPri)}catch(e$77){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToPc Failed][TOOLKIT ERROR] during decoding km private key base64 to binary.";err.detail="error code : "+e$77.code+"\nerror message : "+e$77.message;throw err;}}try{p12=crosscert.pkcs12.makePKCS12(signCert,signPri,kmCert,kmPri,pw,{useMac:true,generateLocalKeyId:true})}catch(e$78){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToPc Failed][TOOLKIT ERROR] during encoding pkcs#12.";err.detail="error code : "+e$78.code+"\nerror message : "+e$78.message;throw err;}var p12der=null;try{p12der=crosscert.asn1.toDer(p12).getBytes()}catch(e$79){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToPc Failed][TOOLKIT ERROR] during getting pkcs#12 binary.";err.detail="error code : "+e$79.code+"\nerror message : "+e$79.message;throw err;}if(retType=="base64"){var base64P12=crosscert.util.encode64(p12der);return{"p12":base64P12,"dn":dn}}else{var arr=new Array(p12der.length);for(var i=0;i<p12der.length;i++)arr[i]=p12der.charCodeAt(i);p12bin=new Uint8Array(arr);return{"p12":p12bin,"dn":dn}}},GetP12ForBuToMo:function(index,encoding){if(!index||!encoding){var err={};err.code=__err_code.ERROR_PARAMETER_VALUE_IS_NULL;err.message="[LocalStorageHandler GetP12ForBuToMo Failed] the parameter value cannot be null.";err.detail=null;throw err;}if("number"!=typeof index||"string"!=typeof encoding||1>index){var err={};err.code=__err_code.ERROR_PARAMETER_TYPE_OF_VALUE_OR_DATA_IS_WRONG;err.message="[LocalStorageHandler GetP12ForBuToMo Failed] the parameter type of value or data is wrong.";err.detail=null;throw err;}if(!__arr_list_user_certs||0>=__arr_list_user_certs.length){var err={};err.code=__err_code.ERROR_NO_USER_CERT_ON_STORAGE_MEMORY;err.message="[LocalStorageHandler GetP12ForBuToMo Failed] user certificate is not loaded or not exist.";err.detail=null;throw err;}var b64SignCert,b64SignPri,b64KmCert,b64kmPri;b64SignCert=b64SignPri=b64KmCert=b64KmPri=null;var p12,strP12,p12key;p12=strP12=p12key=null;var struct=__arr_list_user_certs[index];if(!struct||"undefined"===typeof struct){var err={};err.code=__err_code.ERROR_NO_USER_CERT_RESPONDED_BY_INDEX;err.message="[LocalStorageHandler GetP12ForBuToMo Failed] no user certificate responded by the index.";err.detail=null;throw err;}var b64SignCert=struct["signcert"];var b64SignPri=struct["signpri"];if("undefined"!=typeof struct["kmcert"])if(b64SignCert!=struct["kmcert"]&&b64SignPri!=struct["kmpri"]){b64KmCert=struct["kmcert"];b64KmPri=struct["kmpri"]}try{p12key=crosscert.util.bytesToHex(crosscert.random.getBytes(4))}catch(e$80){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToMo Failed][TOOLKIT ERROR] during making random and converting to hex string.";err.detail="error code : "+e$80.code+"\nerror message : "+e$80.message;throw err;}var signCert=null;try{signCert=crosscert.pki.certificateFromBase64(b64SignCert)}catch(e$81){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToMo Failed][TOOLKIT ERROR] during decoding sign certificate base64 to binary.";err.detail="error code : "+e$81.code+"\nerror message : "+e$81.message;throw err;}var signPri=null;try{signPri=crosscert.pkcs8.encryptedPrivateKeyFromBase64(b64SignPri)}catch(e$82){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToMo Failed][TOOLKIT ERROR] during decoding sign private key base64 to binary.";err.detail="error code : "+e$82.code+"\nerror message : "+e$82.message;throw err;}var kmCert=null;var kmPri=null;if(b64KmCert){try{kmCert=crosscert.pki.certificateFromBase64(b64KmCert)}catch(e$83){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToMo Failed][TOOLKIT ERROR] during decoding km certificate base64 to binary.";err.detail="error code : "+e$83.code+"\nerror message : "+e$83.message;throw err;}try{kmPri=crosscert.pkcs8.encryptedPrivateKeyFromBase64(b64KmPri)}catch(e$84){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToMo Failed][TOOLKIT ERROR] during decoding km private key base64 to binary.";err.detail="error code : "+e$84.code+"\nerror message : "+e$84.message;throw err;}}try{p12=crosscert.pkcs12.makePKCS12FromCertNEncPKCS8(signCert,signPri,kmCert,kmPri,p12key,{useMac:true,generateLocalKeyId:true})}catch(e$85){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToMo Failed][TOOLKIT ERROR] during encrypting pkcs#8 and making pkcs#12.";err.detail="error code : "+e$85.code+"\nerror message : "+e$85.message;throw err;}try{if("hex"===encoding)strP12=crosscert.util.bytesToHex(crosscert.asn1.toDer(p12).getBytes());else strP12=crosscert.util.encode64(crosscert.asn1.toDer(p12).getBytes())}catch(e$86){var err={};err.code=__err_code.ERROR_JSUSTOOLKIT;err.message="[LocalStorageHandler GetP12ForBuToMo Failed][TOOLKIT ERROR] during encoding base64 string or converting hex string.";err.detail="error code : "+e$86.code+"\nerror message : "+e$86.message;throw err;}return{"p12":strP12,"key":p12key}},GetInitCerts:function(){return __json_init_cacerts}}};